# üìò API Reference (English)

`ofc-indexeddb` is an IndexedDB wrapper for TypeScript providing type safety, Promise-based asynchronous operations, and built-in logical delete support.

---

## üóÇÔ∏è Base Interface

All data models stored in the database must extend the **`OfcRec`** interface, which includes the following metadata fields:

```typescript
export interface OfcRec {
¬† id: string;       // Unique record ID (auto-generated using crypto.randomUUID)
¬† inserted: string; // Insertion datetime (auto-generated in ISO 8601 format)
¬† updated: string;  // Update datetime (auto-updated in ISO 8601 format)
¬† deleted: string;  // Deletion datetime (set upon logical delete)
¬† is_delete: boolean; // Deletion flag (true: logically deleted)
}
```

---

## üß± ofcIndexedDB Object

All functionality of the library is provided through the static object **`ofcIndexedDB`**.

### 1. Connection and Management Methods

| Method Name | Description | Arguments | Returns |
| :--- | :--- | :--- | :--- |
| **`connect`** | Opens or creates a database connection. This is a Promise-based asynchronous function. | `name?`: DB name<br>`version?`: Version number<br>`createFunc?`: Schema creation function (executed on `onupgradeneeded`) | `Promise<IDBDatabase>` |
| **`createStore`** | Executes the object store creation function. Intended for use within the `onupgradeneeded` callback of `connect`. | `db`: DB object<br>`createFunc`: Store creation function | `void` |
| **`drop`** | Deletes the entire database. | `name?`: Name of the DB to drop | `Promise<boolean>` (returns `true` on success) |
| **`clear`** | Deletes all records (TRUNCATE equivalent) from the specified object store. | `db`: DB object<br>`store`: Store name | `Promise<boolean>` (returns `true` on success) |
| **`close`** | Closes the current database connection safely. Use this to explicitly release resources when the DB is no longer needed (e.g., test teardown or multi-DB apps). | `db`: DB object (or null) | `Promise<boolean>` (returns `true` on success, `false` if skipped) |

```typescript
// Connection example
const db = await ofcIndexedDB.connect(
¬† 'AppDB',
¬† 1,
¬† (db) => {
¬† ¬† // Schema definition
¬† ¬† db.createObjectStore('users', { keyPath: 'id' }).createIndex('name', 'name');
¬† }
);
```

---

### 2. CRUD (Data Manipulation) Methods

| Method Name | Description | Arguments | Returns |
| :--- | :--- | :--- | :--- |
| **`upsert<T>`** | Inserts or updates a record (Insert if ID does not exist, Update if ID exists). | `db`: DB object<br>`store`: Store name<br>`rec`: Record to insert/update (must extend `OfcRec`)<br>`options?`: Options for ID/datetime generation, Proxy unwrap flag, etc. | `Promise<string>` (Record ID) |
| **`get<T>`** | Retrieves a single record using the ID or an index key. | `db`: DB object<br>`store`: Store name<br>`key`: Search key (ID or index key)<br>`index?`: Name of the index to use | `Promise<T>` (returns `{}` if not found) |
| **`list<T>`** | Retrieves multiple records as an array, optionally by specifying a key range. | `db`: DB object<br>`store`: Store name<br>`index?`: Name of the index to use<br>`from?`: Start key of the range<br>`to?`: End key of the range | `Promise<T[]>` |
| **`select<T>`** | Filters records (WHERE clause equivalent) using a condition function and retrieves the matching array. | `db`: DB object<br>`store`: Store name<br>`where`: Condition function (`(record: T) => boolean`)<br>`options.includeDeleted?`: Flag to include logically deleted records | `Promise<T[]>` |
| **`count`** | Retrieves the number of records in the specified object store. | `db`: DB object<br>`store`: Store name | `Promise<number>` |
| **`delete`** | Deletes a record. Supports **logical delete** (`is_delete = true` setting) via options. | `db`: DB object<br>`store`: Store name<br>`key`: ID of the record to delete<br>`options.logical?`: `true` for logical delete, `false`/omitted for physical delete | `Promise<boolean>` (returns `true` on success) |

---

### 3. Store Definition Shortcuts

| Method Name | Description | Arguments | Returns |
| :--- | :--- | :--- | :--- |
| **`defineStore<T>`** | Generates a type-safe set of CRUD operation methods for a specific store, eliminating the need to pass the store name repeatedly. | `store`: Store name<br>`defaults?`: Default options for ID/datetime generation, logical delete setting, etc. | **Type-safe operation object** (e.g., `Titles.get(db, key)`) |

#### Methods Generated by `defineStore`

The object returned by `defineStore<T>('storeName')` includes the following type-safe methods:

* `list(db, index?, from?, to?)`
* `select(db, where?)`
* `get(db, key, index?)`
* `count(db)`
* `upsert(db, rec, isProxy?)`
* `delete(db, key)` *Behavior follows `defaults.logicalDelete` setting.*
* `clear(db)`

```typescript
// Usage Example (Type-safe shortcut)
// T is the record type
const Users = ofcIndexedDB.defineStore<iUser>('users', {
¬† logicalDelete: true, // Default to logical delete for this specific store
});

// Store name 'users' is no longer needed
const user = await Users.get(db, 'user-id-001');
await Users.delete(db, 'user-id-001'); // Logical delete is executed
```

---

### 4. bindStore<T> ‚Äî Pre-bound Store API (`Recommended`)

Similar to `defineStore`, but automatically binds a specific `IDBDatabase` instance, so you can omit the `db` parameter in all calls.

| Method Name | Description | Returns |
| :--- | :--- | :--- |
| **`bindStore<T>(db, store, defaults?)`** | Generates a type-safe CRUD operation object pre-bound to the specified DB. | Type-safe CRUD object |

* `list(index?, from?, to?)`
* `select(where?)`
* `get(key, index?)`
* `count(db)`
* `upsert(rec, isProxy?)`
* `delete(key)` *Behavior follows `defaults.logicalDelete` setting.*
* `clear(db)`
```typescript
// Example: pre-bound store
const db = await ofcIndexedDB.connect('AppDB', 1, createStoreV1);
const Users = ofcIndexedDB.bindStore<iUser>(db, 'users');

// You can now call methods without passing 'db'
await Users.upsert({ name: 'Alice', age: 25, city: 'Tokyo' });
const list = await Users.select(r => !r.is_delete);
await Users.delete('user-id-001');

// Example: pre-bound store with expressive type-safe query
const db = await ofcIndexedDB.connect('AppDB', 1, createStoreV1);
const Users = ofcIndexedDB.bindStore<iUser>(db, 'users');

// Insert records
await Users.upsert({ name: 'Alice', age: 25, city: 'Tokyo' });
await Users.upsert({ name: 'Bob', age: 30, city: 'Osaka' });
await Users.upsert({ name: 'Charlie', age: 28, city: 'Tokyo' });

// ‚úÖ The power of select()
const tokyoUsers = await Users.select(r => r.city === 'Tokyo' && !r.is_delete);
console.log(tokyoUsers.map(u => u.name));
// ‚Üí ["Alice", "Charlie"]

// You can also perform logical delete without specifying db
await Users.delete(tokyoUsers[0].id);
```
